<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library Management System</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');

        /* General Styles */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { height: 100%; }
        body {
            font-family: 'Poppins', 'Segoe UI', system-ui, sans-serif;
            background-color: #f4f7f9;
            color: #333;
            min-height: 100vh;
            transition: background-color 0.3s ease;
            display: flex; /* Helps footer stay at bottom */
            flex-direction: column; /* Helps footer stay at bottom */
        }
        body.auth-active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 20px auto;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.07);
            overflow: hidden;
            width: 100%; /* Ensure it takes width */
        }
        /* Make app container grow to fill space */
        #app-container {
            flex-grow: 1; 
            display: none; /* JS will show this */
        }

        .header {
            background-color: #3b82f6;
            color: white;
            padding: 25px 30px;
            text-align: center;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { 
            font-size: 2em; 
            margin: 0; 
            font-weight: 600; 
        }
        .nav-tabs {
            display: flex;
            background: #eef2f5;
            padding: 0;
            border-bottom: 2px solid #d1d5db;
            flex-wrap: wrap;
        }
        .nav-tab {
            /* flex: 1; <-- This was removed to make tabs fit content */
            min-width: 120px;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            color: #4b5563;
            transition: background-color 0.2s ease, color 0.2s ease;
            text-align: center;
        }
        .nav-tab:hover {
            background-color: #dbeafe;
            color: #1d4ed8;
        }
        .nav-tab.active {
            background: #ffffff;
            color: #2563eb;
            font-weight: 600;
            border-bottom: 3px solid #3b82f6;
            margin-bottom: -2px;
        }
        .content { padding: 30px; }

        /* Forms */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 500; color: #374151; }
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            background-color: #fff;
            transition: border-color 0.2s ease;
            font-family: 'Poppins', sans-serif;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin: 5px;
            color: white;
            transition: background-color 0.2s ease, box-shadow 0.2s ease, transform 0.15s ease;
        }
        .btn:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .btn-primary { background-color: #3b82f6; } .btn-primary:hover { background-color: #2563eb; box-shadow: 0 2px 5px rgba(59, 130, 246, 0.3); }
        .btn-success { background-color: #10b981; } .btn-success:hover { background-color: #059669; box-shadow: 0 2px 5px rgba(16, 185, 129, 0.3); }
        .btn-danger { background-color: #ef4444; } .btn-danger:hover { background-color: #dc2626; box-shadow: 0 2px 5px rgba(239, 68, 68, 0.3); }
        .btn-warning { background-color: #f59e0b; color: #fff; } .btn-warning:hover { background-color: #d97706; box-shadow: 0 2px 5px rgba(245, 158, 11, 0.3); }
        
        /* Tables */
        .table-container { overflow-x: auto; margin-top: 20px; }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            background-color: white; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
            border-radius: 8px; 
            overflow: hidden; 
        }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #e5e7eb; vertical-align: middle; }
        thead tr { background-color: #f9fafb; color: #374151; font-weight: 600; text-transform: uppercase; font-size: 0.9em; letter-spacing: 0.5px;}
        tbody tr { transition: background-color 0.15s ease; }
        tbody tr.clickable:hover { background-color: #f3f4f6; cursor: pointer; } 
        .book-cover-img {
            width: 50px;
            height: 70px;
            object-fit: cover;
            border-radius: 4px;
            background-color: #eee;
        }

        /* Search Filter */
        .filter-container { margin-bottom: 20px; max-width: 400px; }
        .filter-container input { width: 100%; padding: 10px 15px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 15px; }

        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { 
            background-color: #fff; 
            padding: 30px; 
            width: 90%; 
            max-width: 550px; 
            border-radius: 10px; 
            position: relative; 
            box-shadow: 0 8px 25px rgba(0,0,0,0.1); 
            animation: fadeIn 0.3s; 
        }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-close { color: #9ca3af; position: absolute; top: 10px; right: 15px; font-size: 24px; font-weight: bold; cursor: pointer; } .modal-close:hover { color: #374151; }
        #member-borrowed-list, #student-borrowed-list { list-style: none; padding: 0; margin-top: 15px; max-height: 200px; overflow-y: auto; }
        #member-borrowed-list li, #student-borrowed-list li { background: #f3f4f6; padding: 10px 15px; border-radius: 6px; margin-bottom: 8px; display: flex; justify-content: space-between; font-size: 0.95em;}
        #member-borrowed-list strong, #student-borrowed-list strong { color: #1d4ed8; }
        .modal h2 { margin-bottom: 15px; color: #1f2937; font-weight: 600; }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: #ffffff; border: 1px solid #e5e7eb; color: #374151; padding: 25px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); }
        .stat-number { font-size: 2.2em; font-weight: 600; color: #3b82f6; margin-bottom: 5px; }

        /* Alerts */
        .alert { padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid transparent; }
        .alert-success { background-color: #d1fae5; border-color: #a7f3d0; color: #065f46; }
        .alert-error { background-color: #fee2e2; border-color: #fecaca; color: #991b1b; }
        
        /* UPDATED LOGIN PAGE STYLES */
        #auth-container {
            max-width: 900px;
            width: 100%;
            display: none; /* JS will show this */
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.07);
            overflow: hidden;
            margin: auto; /* Center login box when auth-active */
        }
        .auth-header {
            text-align: center; 
            padding: 30px; 
            background: #f9fafb; 
            border-bottom: 1px solid #eef2f5;
        }
        .auth-header h1 {
            color: #3b82f6;
            font-size: 1.8em;
            font-weight: 600;
        }
        .auth-header p {
            font-size: 1.1em; 
            color: #4b5563; 
            margin-top: 5px;
        }
        .auth-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
        }
        .auth-grid > div {
            padding: 40px;
        }
        .auth-grid > div:first-child {
            border-right: 1px solid #eef2f5;
        }
        .auth-grid h2 {
            text-align: center;
            margin-bottom: 25px;
            color: #1f2937;
            font-weight: 600;
        }
        @media (max-width: 768px) {
            .auth-grid {
                grid-template-columns: 1fr; /* Stack on mobile */
            }
            .auth-grid > div:first-child {
                border-right: none;
                border-bottom: 1px solid #eef2f5;
            }
            .header {
                flex-direction: column;
                gap: 10px;
            }
        }
        
        /* My Account Page Styles */
        #my-account-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        #my-account-fines .stat-number {
            color: #ef4444; /* Red for fines */
        }
        @media (max-width: 768px) {
            #my-account-grid {
                grid-template-columns: 1fr;
            }
        }

        /* --- NEW: Footer Styles --- */
        footer {
            text-align: center;
            padding: 20px;
            margin-top: 30px; /* Pushes it away from content */
            background-color: #eef2f5;
            color: #6b7280;
            font-size: 0.9em;
            width: 100%;
        }
        footer p {
            margin: 5px 0;
        }
        footer a {
            color: #3b82f6;
            text-decoration: none;
        }
        footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body class="auth-active"> <div id="auth-container">
        <div class="auth-header">
            <h1>ðŸ“š Library Management System</h1>
            <p>Welcome! Please log in or register.</p>
        </div>
        
        <div class="content auth-grid">
            
            <div>
                <h2>Admin / Student Login</h2>
                <form id="login-form">
                    <div class="form-group">
                        <label for="login-email">Email</label>
                        <input type="email" id="login-email" required>
                    </div>
                    <div class="form-group">
                        <label for="login-password">Password</label>
                        <input type="password" id="login-password" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
                </form>
            </div>
            
            <div>
                <h2>New Student? Register</h2>
                <form id="register-form">
                    <div class="form-group">
                        <label for="register-name">Full Name</label>
                        <input type="text" id="register-name" required>
                    </div>
                    <div class="form-group">
                        <label for="register-email">Email</label>
                        <input type="email" id="register-email" required>
                    </div>
                    <div class="form-group">
                        <label for="register-password">Password</label>
                        <input type="password" id="register-password" required>
                    </div>
                    <button type="submit" class="btn btn-success" style="width: 100%;">Register</button>
                </form>
            </div>

        </div>
    </div>


    <div id="app-container" class="container" style="display: none;">
        <div class="header">
            <h1>ðŸ“š Library Management System</h1>
            <button id="logout-btn" class="btn btn-danger">Logout</button>
        </div>
        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="dashboard" onclick="showTab(event, 'dashboard')">Dashboard</button>
            <button class="nav-tab" data-tab="books" onclick="showTab(event, 'books')">Books</button>
            <button class="nav-tab student-only" data-tab="my-account" onclick="showTab(event, 'my-account')">My Account</button>
            <button class="nav-tab admin-only" data-tab="members" onclick="showTab(event, 'members')">Members</button>
            <button class="nav-tab admin-only" data-tab="borrow" onclick="showTab(event, 'borrow')">Borrow/Return</button>
            <button class="nav-tab admin-only" data-tab="add-book" onclick="showTab(event, 'add-book')">Add Book</button>
            <button class="nav-tab admin-only" data-tab="add-member" onclick="showTab(event, 'add-member')">Add Member</button>
        </div>

        <div class="content">
            <div id="alert-container"></div>

            <div id="dashboard" class="tab-content">
                <h2>Dashboard</h2>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-number" id="total-books">0</div><div>Total Books</div></div>
                    <div class="stat-card"><div class="stat-number" id="available-books">0</div><div>Available Books</div></div>
                    <div class="stat-card"><div class="stat-number" id="borrowed-books">0</div><div>Borrowed Books</div></div>
                    <div class="stat-card"><div class="stat-number" id="total-members">0</div><div>Total Members</div></div>
                </div>
            </div>

            <div id="my-account" class="tab-content student-only" style="display: none;">
                <h2 id="my-account-name">My Account</h2>
                <div id="my-account-grid">
                    <div class="stat-card" id="my-account-fines">
                        <div class="stat-number" id="my-fines-amount">â‚¹0.00</div>
                        <div>Outstanding Fines</div>
                        <button class="btn btn-warning" id="my-fines-pay-btn" style="display: none; margin-top: 15px;">Pay Fine Now</button>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="my-books-borrowed">0</div>
                        <div>Books Currently Borrowed</div>
                    </div>
                </div>
                <div class="card" style="margin-top: 30px;">
                    <h3>My Borrowed Books</h3>
                    <ul id="student-borrowed-list">
                        </ul>
                </div>
            </div>

            <div id="books" class="tab-content" style="display: none;">
                <h2>Book Catalog</h2>
                <div class="filter-container">
                    <input type="text" id="book-search" onkeyup="loadBooks()" placeholder="ðŸ”Ž Search by title or author...">
                </div>
                <div class="table-container">
                    <table>
                        <thead><tr>
                            <th>Cover</th>
                            <th>Title</th>
                            <th>Author</th>
                            <th>Genre</th>
                            <th>Year</th>
                            <th>Available</th>
                            <th class="admin-only">Actions</th>
                            <th class="student-only">Actions</th>
                        </tr></thead>
                        <tbody id="books-list"></tbody>
                    </table>
                </div>
            </div>

            <div id="members" class="tab-content admin-only" style="display: none;">
                <h2>Library Members</h2>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Name</th><th>Email</th><th>Outstanding Fines</th><th>Books Borrowed</th><th>Actions</th></tr></thead>
                        <tbody id="members-list"></tbody>
                    </table>
                </div>
            </div>

            <div id="borrow" class="tab-content admin-only" style="display: none;">
                <h2>Borrow / Return Books</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <div><h3>Borrow Book</h3><form id="borrow-form"><div class="form-group"><label>Select Member</label><select id="borrow-member" required></select></div><div class="form-group"><label>Select Book</label><select id="borrow-book" required></select></div><div class="form-group"><label>Return Date</label><input type="date" id="return-date" required></div><button type="submit" class="btn btn-primary">Borrow Book</button></form></div>
                    <div><h3>Return Book</h3><form id="return-form"><div class="form-group"><label>Select Borrowed Book</label><select id="return-book" required></select></div><button type="submit" class="btn btn-success">Return Book</button></form></div>
                </div>
            </div>

            <div id="add-book" class="tab-content admin-only" style="display: none;">
                <h2>Add New Book</h2>
                <form id="add-book-form" style="max-width: 600px;">
                    <div class="form-group"><label>Book Title</label><input type="text" id="add-book-title" required></div>
                    <div class="form-group"><label>Author</label><input type="text" id="add-book-author" required></div>
                    <div class="form-group"><label>ISBN</label><input type="text" id="add-book-isbn"></div>
                    <div class="form-group"><label>Cover Image URL</label><input type="text" id="add-book-cover" placeholder="http://example.com/image.jpg"></div>
                    <div class="form-group"><label>Genre</label><input type="text" id="add-book-genre"></div>
                    <div class="form-group"><label>Year Published</label><input type="number" id="add-book-year"></div>
                    <div class="form-group"><label>Copies</label><input type="number" id="add-book-copies" min="1" value="1" required></div>
                    <button type="submit" class="btn btn-primary">Add Book</button>
                </form>
            </div>

            <div id="add-member" class="tab-content admin-only" style="display: none;">
                <h2>Add New Member</h2>
                <form id="add-member-form" style="max-width: 600px;">
                    <div class="form-group"><label>Full Name</label><input type="text" id="add-member-name" required></div>
                    <div class="form-group"><label>Email</label><input type="email" id="add-member-email"></div>
                    <button type="submit" class="btn btn-primary">Add Member</button>
                </form>
            </div>
        </div>
    </div>

    <div id="member-details-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('member-details-modal')">&times;</span>
            <div id="member-modal-body"></div>
        </div>
    </div>

    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('edit-modal')">&times;</span>
            <h2 id="edit-modal-title">Edit Details</h2>
            <form id="edit-form">
                <div id="edit-form-body"></div>
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </form>
        </div>
    </div>

    <div id="qr-modal" class="modal">
        <div class="modal-content" style="text-align: center;">
            <span class="modal-close" onclick="closeModal('qr-modal')">&times;</span>
            <h2 id="qr-modal-title">Pay Outstanding Fine</h2>
            <p>Please scan the QR code below to pay the fine.</p>
            <img src="qr-code.jpg" alt="UPI QR Code" style="width: 250px; max-width: 80%; margin: 20px auto; display: block;">
            <p style="font-size: 1.2em; font-weight: bold;" id="qr-amount-text"></p>
            <p style="font-size: 0.9em; color: #666; margin-top: 15px;">After payment is complete, click "Confirm Payment" to clear the fine in the system.</p>
            <button id="qr-confirm-btn" class="btn btn-success" style="margin-top: 20px;">Confirm Payment</button>
        </div>
    </div>
    <footer>
        <p>Contact Us:</p>
        <p>
            Phone: <a href="tel:8287971046">8287971046</a> | <a href="tel:7876888450">7876888450</a>
        </p>
        <p>
            Email: <a href="mailto:hdas46070@gmail.com">hdas46070@gmail.com</a>
        </p>
    </footer>
    <script>
        // --- API Base ---
        const API_URL = 'http://localhost:3000/api';
        let allBooks = [];
        let allMembers = [];
        let allBorrowed = [];

        // --- Get Page Elements ---
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');

        // --- UTILITY FUNCTIONS ---
        function showAlert(message, type = 'success') {
            const container = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.innerHTML = '';
            container.appendChild(alert);
            setTimeout(() => alert.remove(), 4000);
        }

        const http = {
            async request(url, method = 'GET', data = null) {
                try {
                    const options = {
                        method,
                        headers: { 'Content-Type': 'application/json' },
                    };
                    if (data) {
                        options.body = JSON.stringify(data);
                    }
                    const response = await fetch(API_URL + url, options);
                    
                    if (response.status === 204) return null; // Handle No Content

                    if (!response.ok) {
                        let errorMsg = `HTTP error! Status: ${response.status}`;
                        try {
                            const errorData = await response.json();
                            errorMsg = errorData.message || errorMsg;
                        } catch (e) {
                            errorMsg = "Server returned an unexpected response. Check API_URL.";
                        }
                        throw new Error(errorMsg);
                    }
                    
                    return await response.json();

                } catch (error) {
                    console.error('API Error:', error.message);
                    showAlert(`Error: ${error.message}`, 'error');
                    throw error;
                }
            },
            get: (url) => http.request(url),
            post: (url, data) => http.request(url, 'POST', data),
            delete: (url) => http.request(url, 'DELETE'),
            put: (url, data) => http.request(url, 'PUT'),
        };

        // --- MODAL FUNCTIONS (with fix) ---
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'flex';
            } else {
                console.error('Error: Modal not found with ID:', modalId);
                showAlert('Error: A popup modal is missing.', 'error');
            }
        }
        function closeModal(modalId) { 
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none'; 
            }
        }
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // --- AUTH & NAVIGATION LOGIC ---

        document.addEventListener('DOMContentLoaded', () => {
            const user = localStorage.getItem('currentUser');
            if (user) {
                showApp(JSON.parse(user));
            } else {
                showLogin();
            }
        });

        function showLogin() {
            localStorage.removeItem('currentUser');
            authContainer.style.display = 'block';
            appContainer.style.display = 'none';
            document.body.classList.add('auth-active'); 
        }

        function showApp(user) {
            authContainer.style.display = 'none';
            appContainer.style.display = 'block';
            document.body.classList.remove('auth-active'); 

            // Show/Hide elements based on role
            const adminElements = document.querySelectorAll('.admin-only');
            const studentElements = document.querySelectorAll('.student-only');
            
            if (user.role === 'admin') {
                adminElements.forEach(el => el.style.display = '');
                studentElements.forEach(el => el.style.display = 'none');
                document.querySelectorAll('.nav-tab.admin-only').forEach(el => el.style.display = 'block');
                document.querySelector('th.admin-only').style.display = '';
            } else { // Student
                adminElements.forEach(el => el.style.display = 'none');
                studentElements.forEach(el => el.style.display = '');
                document.querySelectorAll('.nav-tab.student-only').forEach(el => el.style.display = 'block');
                document.querySelector('th.student-only').style.display = '';
            }
            
            showTab(null, 'dashboard');
            document.querySelector('.nav-tab[data-tab="dashboard"]').classList.add('active');
            loadDashboard();
        }

        // Login Form Handler
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            try {
                const user = await http.post('/login', { email, password });
                localStorage.setItem('currentUser', JSON.stringify(user));
                showApp(user);
            } catch (error) {}
        });

        // Register Form Handler (UPDATED)
        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            try {
                await http.post('/register', { name, email, password });
                showAlert('Registration successful! Please log in.', 'success');
                e.target.reset();
                document.getElementById('login-email').value = email;
            } catch (error) {}
        });

        // Logout Button Handler
        document.getElementById('logout-btn').addEventListener('click', showLogin);

        // --- (End of new Auth logic) ---


        // --- Navigation ---
        function showTab(event, tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).style.display = 'block';
            
            if (event) { 
                 event.currentTarget.classList.add('active');
            } else {
                const tabButton = document.querySelector(`.nav-tab[data-tab="${tabName}"]`);
                if (tabButton) tabButton.classList.add('active');
            }

            if (tabName === 'dashboard') loadDashboard();
            if (tabName === 'my-account') loadMyAccount();
            if (tabName === 'books') loadBooks();
            if (tabName === 'members') loadMembers();
            if (tabName === 'borrow') loadBorrowPage();
        }

        // --- Dashboard ---
        async function loadDashboard() {
            try {
                const stats = await http.get('/stats');
                document.getElementById('total-books').textContent = stats.totalBooks;
                document.getElementById('available-books').textContent = stats.availableBooks;
                document.getElementById('borrowed-books').textContent = stats.borrowedBooks;
                document.getElementById('total-members').textContent = stats.totalMembers;
            } catch (error) {}
        }

        // --- NEW: My Account Page ---
        async function loadMyAccount() {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            if (!user) return showLogin();
            
            try {
                const profile = await http.get(`/my-profile/${user.id}`);
                
                document.getElementById('my-account-name').textContent = `Welcome, ${profile.name}`;
                document.getElementById('my-fines-amount').textContent = `â‚¹${parseFloat(profile.outstandingFines).toFixed(2)}`;
                document.getElementById('my-books-borrowed').textContent = profile.booksBorrowed;

                const payBtn = document.getElementById('my-fines-pay-btn');
                if (profile.outstandingFines > 0) {
                    payBtn.style.display = 'block';
                    // This re-uses the admin's payfine logic, but just for this member
                    payBtn.onclick = () => showPayModal(profile.memberId, profile.outstandingFines);
                } else {
                    payBtn.style.display = 'none';
                }

                const bookList = document.getElementById('student-borrowed-list');
                bookList.innerHTML = '';
                if (profile.borrowedBooksList.length === 0) {
                    bookList.innerHTML = '<li>You have no books currently borrowed.</li>';
                } else {
                    profile.borrowedBooksList.forEach(book => {
                        bookList.innerHTML += `<li><span>${book.bookTitle}</span><strong>Due: ${book.dueDate}</strong></li>`;
                    });
                }
            } catch (error) {
                showAlert('Could not load your profile. Please log in again.', 'error');
                showLogin();
            }
        }

        // --- Books Page (UPDATED) ---
        async function loadBooks() {
            try {
                const searchTerm = document.getElementById('book-search').value.toLowerCase();
                allBooks = await http.get(`/books?q=${searchTerm}`);
                const tableBody = document.getElementById('books-list');
                tableBody.innerHTML = '';
                if (allBooks.length === 0) {
                     tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No books found.</td></tr>';
                     return;
                }
                
                const user = JSON.parse(localStorage.getItem('currentUser'));
                
                allBooks.forEach(book => {
                    const isAdmin = user.role === 'admin';
                    const isAvailable = book.available > 0;
                    
                    tableBody.innerHTML += `
                        <tr>
                            <td><img src="${book.coverImageURL || 'https://via.placeholder.com/50x70.png?text=No+Image'}" alt="Cover" class="book-cover-img"></td>
                            <td>${book.title}</td>
                            <td>${book.author}</td>
                            <td>${book.genre || 'N/A'}</td>
                            <td>${book.year || 'N/A'}</td>
                            <td>${book.available} / ${book.copies}</td>
                            
                            ${isAdmin ? `
                            <td class="admin-only">
                                <button class="btn btn-primary" onclick="editBook(${book.id})">Edit</button>
                                <button class="btn btn-danger" onclick="deleteBook(${book.id})">Delete</button>
                            </td>
                            ` : `
                            <td class="student-only">
                                <button class="btn btn-success" onclick="studentBorrow(${book.id})" ${!isAvailable ? 'disabled' : ''}>
                                    ${isAvailable ? 'Borrow' : 'Unavailable'}
                                </button>
                            </td>
                            `}
                        </tr>
                    `;
                });
            } catch (error) {}
        }
        
        // --- NEW: Student Borrow Function ---
        async function studentBorrow(bookId) {
            if (!confirm("Are you sure you want to borrow this book for 2 weeks?")) return;
            
            const user = JSON.parse(localStorage.getItem('currentUser'));
            if (!user) return showLogin();
            
            const today = new Date();
            today.setDate(today.getDate() + 14);
            const dueDate = today.toISOString().split('T')[0];
            
            try {
                await http.post('/student/borrow', {
                    bookId: bookId,
                    dueDate: dueDate,
                    userId: user.id
                });
                showAlert('Book borrowed successfully!', 'success');
                loadBooks(); // Refresh list
                loadDashboard(); // Refresh stats
            } catch (error) {
                // Alert shown by http handler
            }
        }

        // Add Book Form
        document.getElementById('add-book-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const book = {
                title: document.getElementById('add-book-title').value,
                author: document.getElementById('add-book-author').value,
                isbn: document.getElementById('add-book-isbn').value,
                genre: document.getElementById('add-book-genre').value,
                year: parseInt(document.getElementById('add-book-year').value) || null,
                copies: parseInt(document.getElementById('add-book-copies').value),
                coverImageURL: document.getElementById('add-book-cover').value
            };

            if (!book.title || !book.author || !book.copies) {
                showAlert('Title, Author, and Copies are required fields.', 'error');
                return;
            }

            try {
                await http.post('/books', book);
                showAlert('Book added successfully!', 'success');
                e.target.reset();
                loadBooks();
                loadDashboard();
            } catch (error) {}
        });

        async function deleteBook(id) {
            if (!confirm('Are you sure you want to delete this book?')) return;
            try {
                await http.delete(`/books/${id}`);
                showAlert('Book deleted successfully!', 'success');
                loadBooks();
                loadDashboard();
            } catch (error) {}
        }

        // --- Members Page ---
        async function loadMembers() {
            try {
                allMembers = await http.get('/members');
                const tableBody = document.getElementById('members-list');
                tableBody.innerHTML = '';
                if (allMembers.length === 0) {
                     tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No members found.</td></tr>';
                     return;
                }
                allMembers.forEach(member => {
                    const finesValue = parseFloat(member.outstandingFines) || 0;
                    const fines = finesValue.toFixed(2);
                    const borrowed = member.booksBorrowed || 0;

                    tableBody.innerHTML += `
                        <tr class="clickable" onclick="showMemberDetails(${member.id}, '${member.name}')">
                            <td>${member.name}</td>
                            <td>${member.email || 'N/A'}</td>
                            <td>â‚¹${fines}</td>
                            <td>${borrowed}</td>
                            <td onclick="event.stopPropagation()">
                                <button class="btn btn-primary" onclick="editMember(${member.id})">Edit</button>
                                <button class="btn btn-warning" onclick="showPayModal(${member.id}, ${finesValue})" ${finesValue <= 0 ? 'disabled' : ''}>Pay Fines</button>
                                <button class="btn btn-danger" onclick="deleteMember(${member.id})">Delete</button>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.error("Failed to load members:", error);
                showAlert("Failed to load members: " + error.message, 'error');
            }
        }

        // Add Member Form
        document.getElementById('add-member-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const member = {
                name: document.getElementById('add-member-name').value,
                email: document.getElementById('add-member-email').value,
            };

            if (!member.name) {
                showAlert('Name is a required field.', 'error');
                return;
            }

            try {
                // This route is admin-only, and will create an un-linked member
                await http.post('/members', member);
                showAlert('Member added successfully!', 'success');
                e.target.reset();
                loadMembers();
                loadDashboard();
            } catch (error) {}
        });

        async function deleteMember(id) {
            if (!confirm('Are you sure you want to delete this member?')) return;
            try {
                await http.delete(`/members/${id}`);
                showAlert('Member deleted successfully!', 'success');
                loadMembers();
                loadDashboard();
            } catch (error) {}
        }

        async function payFines(id) {
            try {
                const res = await http.post(`/members/${id}/pay-fines`);
                showAlert(res.message, 'success');
                loadMembers(); // Refresh admin list
                loadMyAccount(); // Refresh student list
            } catch (error) {}
        }

        // --- EDIT AND DETAILS FUNCTIONS ---

        async function showMemberDetails(memberId, memberName) {
            const modalBody = document.getElementById('member-modal-body');
            modalBody.innerHTML = `<h2>${memberName}'s Borrows</h2><p>Loading...</p>`;
            openModal('member-details-modal');
            try {
                const memberBooks = await http.get(`/members/${memberId}/borrowed`);
                let content = `<h2>${memberName}'s Borrows</h2>`;
                if (memberBooks.length === 0) {
                    content += '<p>This member has no books currently borrowed.</p>';
                } else {
                    content += '<ul id="member-borrowed-list">';
                    content += memberBooks.map(book => `<li><span>${book.bookTitle}</span><strong>Due: ${book.dueDate}</strong></li>`).join('');
                    content += '</ul>';
                }
                modalBody.innerHTML = content;
            } catch (error) {
                modalBody.innerHTML = `<p>Could not load member details.</p>`;
                showAlert('Could not load member details.', 'error');
            }
        }

        function editBook(id) {
            const book = allBooks.find(b => b.id === id);
            if (!book) return;

            document.getElementById('edit-modal-title').textContent = "Edit Book";
            const formBody = document.getElementById('edit-form-body');

            // --- THIS IS THE LINE WITH THE FIX ---
            formBody.innerHTML = `
                <div class="form-group"><label>Book Title</label><input type="text" id="edit-book-title" value="${book.title}" required></div>
                <div class="form-group"><label>Author</label><input type="text" id="edit-book-author" value="${book.author}" required></div>
                <div class="form-group"><label>ISBN</label><input type="text" id="edit-book-isbn" value="${book.isbn || ''}"></div>
                <div class="form-group"><label>Cover Image URL</label><input type="text" id="edit-book-cover" value="${book.coverImageURL || ''}"></div>
                <div class="form-group"><label>Genre</label><input type="text" id="edit-book-genre" value="${book.genre || ''}"></div>
                <div class="form-group"><label>Year Published</label><input type="number" id="edit-book-year" value="${book.year || ''}"></div>
                <div class="form-group"><label>Copies</label><input type="number" id="edit-book-copies" value="${book.copies}" min="1" required></div>
            `;
            // --- END FIX ---

            document.getElementById('edit-form').onsubmit = (e) => saveBookChanges(e, id);
            openModal('edit-modal');
        }

        // Edit Book Form
        async function saveBookChanges(event, id) {
            event.preventDefault();
            const updatedBook = {
                title: document.getElementById('edit-book-title').value,
                author: document.getElementById('edit-book-author').value,
                isbn: document.getElementById('edit-book-isbn').value,
                genre: document.getElementById('edit-book-genre').value,
                year: parseInt(document.getElementById('edit-book-year').value) || null,
                copies: parseInt(document.getElementById('edit-book-copies').value),
                coverImageURL: document.getElementById('edit-book-cover').value
            };

            if (!updatedBook.title || !updatedBook.author || !updatedBook.copies) {
                showAlert('Title, Author, and Copies cannot be empty.', 'error');
                return;
            }

            try {
                await http.put(`/books/${id}`, updatedBook);
                closeModal('edit-modal');
                showAlert('Book updated successfully!', 'success');
                loadBooks();
                loadDashboard();
            } catch (error) {}
        }

        function editMember(id) {
            const member = allMembers.find(m => m.id === id);
            if (!member) return;

            document.getElementById('edit-modal-title').textContent = "Edit Member";
            const formBody = document.getElementById('edit-form-body');

            formBody.innerHTML = `
                <div class="form-group"><label>Full Name</label><input type="text" id="edit-member-name" value="${member.name}" required></div>
                <div class="form-group"><label>Email</label><input type="email" id="edit-member-email" value="${member.email || ''}"></div>
                <p style="font-size: 0.9em; color: #666;">Fines and borrowed counts are updated automatically by borrow/return actions.</p>
            `;

            document.getElementById('edit-form').onsubmit = (e) => saveMemberChanges(e, id);
            openModal('edit-modal');
        }

        // Edit Member Form
        async function saveMemberChanges(event, id) {
            event.preventDefault();
            const updatedMember = {
                name: document.getElementById('edit-member-name').value,
                email: document.getElementById('edit-member-email').value,
            };

            if (!updatedMember.name) {
                showAlert('Name cannot be empty.', 'error');
                return;
            }

            try {
                await http.put(`/members/${id}`, updatedMember);
                closeModal('edit-modal');
                showAlert('Member updated successfully!', 'success');
                loadMembers();
            } catch (error) {}
        }
        
        // --- PAYMENT MODAL FUNCTIONS ---
        function showPayModal(id, amount) {
            document.getElementById('qr-amount-text').textContent = `Amount to Pay: â‚¹${amount.toFixed(2)}`;
            document.getElementById('qr-confirm-btn').dataset.memberId = id;
            openModal('qr-modal');
        }

        document.getElementById('qr-confirm-btn').addEventListener('click', async () => {
            const id = document.getElementById('qr-confirm-btn').dataset.memberId;
            if (id) {
                await payFines(parseInt(id));
                closeModal('qr-modal');
            }
        });


        // --- Borrow/Return Page (UPDATED with DATE FIX) ---
        async function loadBorrowPage() {
            try {
                [allBooks, allMembers, allBorrowed] = await Promise.all([
                    http.get('/books'),
                    http.get('/members'),
                    http.get('/borrowed')
                ]);

                const memberSelect = document.getElementById('borrow-member');
                memberSelect.innerHTML = '<option value="">Select a Member</option>';
                allMembers.forEach(m => {
                    memberSelect.innerHTML += `<option value="${m.id}">${m.name}</option>`;
                });

                const bookSelect = document.getElementById('borrow-book');
                bookSelect.innerHTML = '<option value="">Select a Book</option>';
                allBooks.filter(b => b.available > 0).forEach(b => {
                    bookSelect.innerHTML += `<option value="${b.id}">${b.title} (by ${b.author})</option>`;
                });

                const returnSelect = document.getElementById('return-book');
                returnSelect.innerHTML = '<option value="">Select a Borrowed Book to Return</option>';
                allBorrowed.forEach(r => {
                    returnSelect.innerHTML += `<option value="${r.id}">${r.bookTitle} (Borrowed by ${r.memberName})</goption>`;
                });

                // --- DATE FIX STARTS HERE ---
                
                // Helper to format a date as YYYY-MM-DD
                const formatDate = (date) => {
                    const year = date.getFullYear();
                    const month = (date.getMonth() + 1).toString().padStart(2, '0');
                    const day = date.getDate().toString().padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }

                // 1. Set the minimum date to today (local)
                const today = new Date();
                document.getElementById('return-date').min = formatDate(today);

                // 2. Set the default value to 2 weeks from now (local)
                const defaultDueDate = new Date();
                defaultDueDate.setDate(defaultDueDate.getDate() + 14);
                document.getElementById('return-date').value = formatDate(defaultDueDate);
                
                // --- DATE FIX ENDS HERE ---

            } catch (error) {}
        }

        document.getElementById('borrow-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const borrowData = {
                memberId: parseInt(document.getElementById('borrow-member').value),
                bookId: parseInt(document.getElementById('borrow-book').value),
                dueDate: document.getElementById('return-date').value,
            };
            try {
                const res = await http.post('/borrow', borrowData);
                showAlert(res.message, 'success');
                e.target.reset();
                loadBorrowPage();
                loadDashboard();
            } catch (error) {}
        });
        
        document.getElementById('return-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const returnData = {
                borrowId: parseInt(document.getElementById('return-book').value),
            };
            try {
                const res = await http.post('/return', returnData);
                showAlert(res.message, 'success');
                e.target.reset();
                loadBorrowPage();
                loadDashboard();
                loadMembers();
            } catch (error) {}
        });

    </script>
</body>
</html>